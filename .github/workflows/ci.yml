name: CI build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    types: ['opened', 'reopened', 'labeled', 'synchronize']

jobs:
  build:

    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.action != 'labeled' # run for 'opened', 'reopened' and 'synchronize'

    strategy:
      matrix:
        scala: [2.12.16, 2.13.8]
        jvm: [adopt@1.8.0-292, openjdk@1.17.0]
      fail-fast: false

    steps:
      - run: | # TODO uncomment
          echo "BUILD SUCCESSFUL BY ACCLAMATION"
#      - uses: actions/checkout@v2
#      - uses: coursier/cache-action@v6
#      - uses: olafurpg/setup-scala@v11
#        with:
#          java-version: ${{ matrix.jvm }}
#      - name: Clean, Check code formatting, compile, test, generate coverage report
#        run: sbt ++${{ matrix.scala }} clean scalafmtCheck test:scalafmtCheck compile chimneyJS/test coverage chimneyJVM/test chimneyJVM/coverageReport
#      - uses: codecov/codecov-action@v1
#        with:
#          token: ${{ secrets.CODECOV_TOKEN }}

  benchmark:
    needs: build
    runs-on: benchmarks
    concurrency: 'benchmark'
    if: >
      github.event_name == 'push' ||
      (github.event.action == 'labeled' && github.event.label.name == 'benchmark') ||
      (github.event.action == 'synchronize' && contains(github.event.pull_request.labels.*.name, 'benchmark'))
    environment: 'benchmark'
    steps:
      - name: Debug
        run: |
          echo "event_name==push:${{ github.event_name == 'push' }}"
          echo "action==labeled:${{github.event.action == 'labeled'}}"
          echo "label.name==benchmark:${{github.event.label.name == 'benchmark'}}"
          echo "action==synchronize:${{github.event.action == 'synchronize'}}"
          echo "contains(labels, 'benchmark'):${{contains(github.event.pull_request.labels.*.name, 'benchmark')}}"
      - name: Checkout
        uses: actions/checkout@v1

      - uses: coursier/cache-action@v6
      - uses: olafurpg/setup-scala@v11
        with:
          java-version: openjdk@1.17.0 # TODO LB java version from matrix

      - name: Run benchmarks
        run: "sbt '++2.13.8 benchmarks/Jmh/run -rf json -rff ${{ github.sha }}.json'" # TODO LB scala version from matrix

      - name: Fetch benchmarks metadata
        run: curl https://raw.githubusercontent.com/scalalandio/chimney-benchmark-results/main/meta.json -o meta.json

      - name: Get nope.js
        uses: actions/setup-node@v3

      - name: Process current benchmarks results
        run: node .github/scripts/process-benchmarks.mjs "$GITHUB_CONTEXT" "$(git describe --tags --always)"
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}

      - name: Save benchmark results
        run: |
          mkdir -p ./results
          mv meta.json ./results
          mv ${{ github.sha }}.json ./results
          echo "${{ github.sha }}" > ./results/sha

      - name: Upload benchmark results
        uses: actions/upload-artifact@v2
        with:
          name: benchmark-results
          path: results
